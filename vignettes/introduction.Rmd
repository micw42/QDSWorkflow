---
title: "Introduction to using QDSWorkflow package to predict quiescence depth"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(QDSWorkflow))
```

# Using pre-built model to predict quiesence depth
## Preprocess test data (muscle regeneration dataset)
```{r}
#data already loaded in variable musc_raw
test_df = musc_raw %>% BulkPreproc()    #normalize
test_df = test_df %>% convertSpecies(hm=mouse_rat_hm, old_id = "Gene stable ID", new_id = "Rat gene stable ID")  #convert to rat IDs
```

## Make QDS prediction
```{r }
qds_df = PrebuiltQDSModel(test_df)
```

## Make boxplot of predicted QDS values
```{r }
#Muscle regeneration dataset metadata already loaded in variable musc_ann
make_boxplot(qds_df, musc_ann, "Condition", title="QDS of muscle stem cells \n under different \nperfusion conditions")
```

# Building new QDS model and predicting on test data
## Download the lung cancer epithelial dataset [here](https://drive.google.com/file/d/1NhgnEEFASni6vHdG0UbEu9MokiScfhpB/view)
## Preprocess test data (lung cancer epithelial dataset)
```{r }
#Load the data
test_df = readRDS("../../Lung_Cancer_Epithelial_raw.rds") #Replace with correct path

#Filter doublets
#Lung cancer epithelial metadata already loaded in variable lc_ann
test_df = test_df %>% FilterDoublets(ann_df=lc_ann, split.by="Sample", id_col="Index") 

#Filter and normalize the test data
test_df = test_df %>% scPreproc()

#Convert the gene names to human Ensembl IDs, and convert the human Ensembl IDs to rat Ensembl IDs
#gene map already loaded in variable lc_gene_map
#rat-human homology already loaded in variable rat_human_hm
test_df = test_df %>%
  convertSymbol(gene_map = lc_gene_map) %>%
  convertSpecies(hm=rat_human_hm, old_id = "Gene stable ID", new_id = "Rat gene stable ID")
```




